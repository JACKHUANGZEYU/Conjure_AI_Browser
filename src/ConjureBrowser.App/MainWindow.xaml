<Window x:Class="ConjureBrowser.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:cef="clr-namespace:CefSharp.Wpf;assembly=CefSharp.Wpf"
        xmlns:models="clr-namespace:ConjureBrowser.App.Models"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="Conjure Browser"
        Height="720"
        Width="1200"
        Background="{DynamicResource ChromeBackground}"
        TextElement.Foreground="{DynamicResource ChromeText}"
        TextElement.FontFamily="{DynamicResource MaterialDesignFont}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />

        <!-- DataTemplate for TabHeaderModel -->
        <DataTemplate DataType="{x:Type models:TabHeaderModel}">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <!-- Favicon placeholder (globe icon) - hidden by default, shown when favicon is null -->
                <TextBlock x:Name="FaviconPlaceholder"
                           Text="ðŸŒ"
                           FontSize="12"
                           VerticalAlignment="Center"
                           Margin="0,0,6,0"
                           Foreground="{DynamicResource ChromeTextSecondary}"
                           Visibility="Collapsed" />
                <!-- Favicon image - visible by default -->
                <Image x:Name="FaviconImage"
                       Source="{Binding Favicon}"
                       Width="16"
                       Height="16"
                       VerticalAlignment="Center"
                       Margin="0,0,6,0"
                       Visibility="Visible" />
                <!-- Title -->
                <TextBlock Text="{Binding Title}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"
                           MaxWidth="140"
                           Foreground="{DynamicResource ChromeText}" />
                <!-- Loading indicator -->
                <TextBlock Text="âŸ³"
                           FontSize="12"
                           VerticalAlignment="Center"
                           Margin="6,0,0,0"
                           Foreground="{DynamicResource ChromeAccent}"
                           Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}" />
            </StackPanel>
            <DataTemplate.Triggers>
                <!-- When Favicon IS null, show placeholder and hide image -->
                <DataTrigger Binding="{Binding Favicon}" Value="{x:Null}">
                    <Setter TargetName="FaviconPlaceholder" Property="Visibility" Value="Visible" />
                    <Setter TargetName="FaviconImage" Property="Visibility" Value="Collapsed" />
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </Window.Resources>

    <DockPanel LastChildFill="True">
        <!-- Top toolbar -->
        <Border DockPanel.Dock="Top" Padding="8,6" Background="{DynamicResource ChromeToolbar}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Name="BackButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="36" Margin="0,0,4,0" Content="â—€" FontSize="12" Click="Back_Click" ToolTip="Back" />
                <Button Grid.Column="1" Name="ForwardButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="36" Margin="0,0,4,0" Content="â–¶" FontSize="12" Click="Forward_Click" ToolTip="Forward" />
                <Button Grid.Column="2" Name="ReloadButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="36" Margin="0,0,4,0" Content="â†»" FontSize="16" Click="Reload_Click" ToolTip="Reload" />
                <Button Grid.Column="3" Style="{StaticResource ChromeToolbarButton}"
                        Width="36" Margin="0,0,8,0" Content="ðŸ " FontSize="14" Click="Home_Click" ToolTip="Home" />

                <!-- Address Bar with Material Design styling -->
                <Border Grid.Column="4" Background="{DynamicResource ChromeTabActive}" CornerRadius="18" 
                        Margin="0,0,8,0" Padding="12,0">
                    <TextBox Name="AddressBar"
                             Background="Transparent"
                             Foreground="{DynamicResource ChromeText}"
                             CaretBrush="{DynamicResource ChromeText}"
                             BorderThickness="0"
                             VerticalContentAlignment="Center"
                             FontSize="14"
                             KeyDown="AddressBar_KeyDown"
                             PreviewMouseLeftButtonDown="AddressBar_PreviewMouseLeftButtonDown"
                             TextChanged="AddressBar_TextChanged"
                             LostKeyboardFocus="AddressBar_LostKeyboardFocus"
                             PreviewKeyDown="AddressBar_PreviewKeyDown" />
                </Border>

                <Button Grid.Column="5" Style="{StaticResource ChromeToolbarButton}"
                        Width="50" Margin="0,0,4,0" Content="Go" Click="Go_Click" />

                <Button Grid.Column="6" Name="BookmarksMenuButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="50" Margin="0,0,4,0" Content="â˜…â–¼" ToolTip="Open bookmarks" Click="BookmarksMenu_Click" />

                <ToggleButton Grid.Column="7" Name="BookmarkButton" Style="{StaticResource ChromeToggleButton}"
                              Width="36" Content="â˜†" ToolTip="Bookmark this page" Click="BookmarkButton_Click" />

                <ToggleButton Grid.Column="8" Name="AiPanelToggle" Style="{StaticResource ChromeToggleButton}"
                              Width="44" Margin="4,0" Content="AI" IsChecked="False" 
                              ToolTip="Show/hide AI panel" Click="AiPanelToggle_Click" />

                <!-- AI Tools Menu Button -->
                <Button Grid.Column="9" Name="AiToolsButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="40" Margin="0,0,4,0" Content="ðŸ› " FontSize="16"
                        ToolTip="AI Tools" Click="AiToolsButton_Click">
                    <Button.ContextMenu>
                        <ContextMenu x:Name="AiToolsMenu" MinWidth="200" />
                    </Button.ContextMenu>
                </Button>

                <!-- App Menu Button -->
                <Button Grid.Column="10" Name="AppMenuButton" Style="{StaticResource ChromeToolbarButton}"
                        Width="36" Content="â‹®" FontSize="18" FontWeight="Bold"
                        ToolTip="Menu" Click="AppMenuButton_Click">
                    <Button.ContextMenu>
                        <ContextMenu x:Name="AppMenu" MinWidth="220" Opened="AppMenu_Opened">
                            <!-- New -->
                            <MenuItem Header="_New Tab" InputGestureText="Ctrl+T" Click="NewTabFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="+" FontWeight="Bold" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- Library -->
                            <MenuItem Header="_History" InputGestureText="Ctrl+H" Click="HistoryFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â±" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="_Downloads" InputGestureText="Ctrl+J" Click="DownloadsFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â¬‡" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- Page -->
                            <MenuItem x:Name="FindInPageMenuItem" Header="_Find in Pageâ€¦" InputGestureText="Ctrl+F" Click="FindInPageFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="ðŸ”Ž" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- App -->
                            <MenuItem Header="_Settings" Click="SettingsFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="âš™" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="_About" Click="AboutFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â„¹" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <MenuItem Header="E_xit" InputGestureText="Alt+F4" Click="ExitFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="âœ•" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
            </Grid>
        </Border>

        <!-- Omnibox Suggestions Popup -->
        <Popup x:Name="OmniboxPopup"
               PlacementTarget="{Binding ElementName=AddressBar}"
               Placement="Bottom"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border Background="{DynamicResource ChromeTabActive}"
                    BorderBrush="{DynamicResource ChromeBorder}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="4"
                    Margin="0,4,0,0">
                <ListBox x:Name="OmniboxList"
                         MaxHeight="300"
                         Width="{Binding ActualWidth, ElementName=AddressBar}"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         MouseLeftButtonUp="OmniboxList_MouseLeftButtonUp"
                         PreviewMouseDown="OmniboxList_PreviewMouseDown"
                         BorderThickness="0"
                         Background="Transparent">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="Foreground" Value="{DynamicResource ChromeText}" />
                            <Setter Property="Padding" Value="8,6" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="ItemBorder" Background="{TemplateBinding Background}"
                                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="ItemBorder" Property="Background" Value="{DynamicResource ChromeTabHover}" />
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="ItemBorder" Property="Background" Value="{DynamicResource ChromeButtonHover}" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="24"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding IconText}"
                                           VerticalAlignment="Center"
                                           FontSize="14"/>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="{Binding PrimaryText}"
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource ChromeText}"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding SecondaryText}"
                                               Foreground="{DynamicResource ChromeTextSecondary}"
                                               FontSize="11"
                                               TextTrimming="CharacterEllipsis"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Border>
        </Popup>

        <!-- Bookmarks Bar -->
        <Border DockPanel.Dock="Top"
                Padding="8,4"
                Background="{DynamicResource ChromeToolbar}"
                BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource ChromeBorder}">
            <Grid>
                <!-- Empty hint (visible when no bookmarks) -->
                <TextBlock Name="BookmarksBarEmptyHint"
                           Text="No bookmarks yet â€” click â˜† to add"
                           Foreground="{DynamicResource ChromeTextSecondary}"
                           VerticalAlignment="Center"
                           FontSize="12"
                           Margin="4,0" />

                <!-- Bookmarks container (visible when bookmarks exist) -->
                <StackPanel Name="BookmarksBarPanel"
                            Orientation="Horizontal"
                            Visibility="Collapsed"
                            ClipToBounds="True" />
            </Grid>
        </Border>

        <!-- Main content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition x:Name="AiResizeColumn" Width="0" />
                <ColumnDefinition x:Name="AiColumn" Width="0" MinWidth="0" MaxWidth="700" />
            </Grid.ColumnDefinitions>

            <!-- Browser tabs + content -->
            <Grid Grid.Column="0">
                <TabControl x:Name="Tabs"
                            SelectionChanged="Tabs_SelectionChanged"
                            BorderThickness="0"
                            Background="{DynamicResource ChromeBackground}"
                            Padding="0">
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem">
                            <Setter Property="Background" Value="{DynamicResource ChromeTabBackground}" />
                            <Setter Property="Foreground" Value="{DynamicResource ChromeText}" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0,4,0,0" />
                            <Setter Property="MinWidth" Value="80" />
                            <Setter Property="MaxWidth" Value="240" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="TabItem">
                                        <Grid x:Name="Root" SnapsToDevicePixels="true">
                                            <Border x:Name="TabBorder"
                                                    Background="{TemplateBinding Background}"
                                                    CornerRadius="8,8,0,0"
                                                    Padding="10,6"
                                                    Margin="1,0">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" MinWidth="20" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <!-- Tab Header Content -->
                                                    <ContentPresenter Grid.Column="0"
                                                                      ContentSource="Header"
                                                                      VerticalAlignment="Center"
                                                                      HorizontalAlignment="Left"
                                                                      RecognizesAccessKey="True" />
                                                    <!-- Close Button - Always visible -->
                                                    <Button x:Name="CloseButton"
                                                            Grid.Column="1"
                                                            Width="18" Height="18"
                                                            Margin="6,0,0,0"
                                                            Padding="0"
                                                            Content="Ã—"
                                                            Foreground="{DynamicResource ChromeTextSecondary}"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Cursor="Hand"
                                                            VerticalAlignment="Center"
                                                            Tag="{Binding RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                            Click="CloseTab_Click"
                                                            ToolTip="Close tab">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="CloseBorder"
                                                                        Background="Transparent"
                                                                        CornerRadius="9"
                                                                        Width="18" Height="18">
                                                                    <TextBlock Text="Ã—"
                                                                               HorizontalAlignment="Center"
                                                                               VerticalAlignment="Center"
                                                                               FontSize="14"
                                                                               Foreground="{DynamicResource ChromeTextSecondary}"
                                                                               Margin="0,-1,0,0" />
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="CloseBorder" Property="Background" Value="{DynamicResource ChromeCloseHover}" />
                                                                    </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <!-- Hover state -->
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="TabBorder" Property="Background" Value="{DynamicResource ChromeTabHover}" />
                                            </Trigger>
                                            <!-- Selected state -->
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="TabBorder" Property="Background" Value="{DynamicResource ChromeTabActive}" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.ItemContainerStyle>
                    <!-- New Tab button as the last item in the tab strip -->
                    <TabControl.Template>
                        <ControlTemplate TargetType="TabControl">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <!-- Tab header row with tabs and + button -->
                                <Border Grid.Row="0" Background="{DynamicResource ChromeBackground}" Padding="4,0">
                                    <StackPanel Orientation="Horizontal">
                                        <TabPanel IsItemsHost="True" />
                                        <Button x:Name="NewTabButton"
                                                Style="{StaticResource ChromeNewTabButton}"
                                                Margin="4,4,0,0"
                                                Click="NewTab_Click"
                                                ToolTip="New tab (Ctrl+T)" />
                                    </StackPanel>
                                </Border>
                                <!-- Tab content area -->
                                <Border Grid.Row="1"
                                        BorderThickness="0"
                                        Background="{TemplateBinding Background}">
                                    <ContentPresenter ContentSource="SelectedContent" />
                                </Border>
                            </Grid>
                        </ControlTemplate>
                    </TabControl.Template>
                </TabControl>

                <!-- Find bar overlay -->
                <Border x:Name="FindBarContainer"
                        Visibility="Collapsed"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="10,40,10,0"
                        Padding="12,8"
                        CornerRadius="8"
                        BorderThickness="1"
                        Background="{DynamicResource ChromeToolbar}"
                        BorderBrush="{DynamicResource ChromeBorder}">
                    <StackPanel Orientation="Horizontal">
                        <Border Background="{DynamicResource ChromeTabActive}" CornerRadius="4" Padding="8,4">
                            <TextBox x:Name="FindTextBox"
                                     Width="200"
                                     Background="Transparent"
                                     Foreground="{DynamicResource ChromeText}"
                                     CaretBrush="{DynamicResource ChromeText}"
                                     BorderThickness="0"
                                     VerticalContentAlignment="Center"
                                     TextChanged="FindTextBox_TextChanged"
                                     PreviewKeyDown="FindTextBox_PreviewKeyDown" />
                        </Border>
                        <ToggleButton x:Name="FindMatchCaseToggle"
                                      Style="{StaticResource ChromeToggleButton}"
                                      Width="32" Height="28"
                                      Margin="6,0,0,0"
                                      Content="Aa"
                                      FontSize="12"
                                      ToolTip="Match case"
                                      Checked="FindMatchCaseToggle_Changed"
                                      Unchecked="FindMatchCaseToggle_Changed" />
                        <Button x:Name="FindPrevButton" Style="{StaticResource ChromeToolbarButton}"
                                Width="32" Margin="4,0,0,0" Content="â†‘" ToolTip="Previous (Shift+Enter)"
                                Click="FindPrevButton_Click" />
                        <Button x:Name="FindNextButton" Style="{StaticResource ChromeToolbarButton}"
                                Width="32" Margin="2,0,0,0" Content="â†“" ToolTip="Next (Enter)"
                                Click="FindNextButton_Click" />
                        <TextBlock x:Name="FindCountText"
                                   Text="0/0"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0"
                                   MinWidth="40"
                                   Foreground="{DynamicResource ChromeTextSecondary}" />
                        <Button x:Name="FindCloseButton" Style="{StaticResource ChromeToolbarButton}"
                                Width="28" Margin="6,0,0,0" Content="âœ•" ToolTip="Close (Esc)"
                                Click="FindCloseButton_Click" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- AI Panel Resize Handle -->
            <Border x:Name="AiResizeHandle"
                    Grid.Column="1"
                    Width="6"
                    Background="Transparent"
                    Cursor="SizeWE"
                    MouseEnter="AiResizeHandle_MouseEnter"
                    MouseLeave="AiResizeHandle_MouseLeave"
                    MouseLeftButtonDown="AiResizeHandle_MouseLeftButtonDown"
                    MouseLeftButtonUp="AiResizeHandle_MouseLeftButtonUp"
                    MouseMove="AiResizeHandle_MouseMove">
                <Border x:Name="AiResizeHandleVisual"
                        Width="2"
                        Background="{DynamicResource ChromeBorder}"
                        Opacity="0"
                        HorizontalAlignment="Center" />
            </Border>

            <!-- AI panel -->
            <Border Grid.Column="2"
                    BorderThickness="1,0,0,0"
                    BorderBrush="{DynamicResource ChromeBorder}"
                    Background="{DynamicResource ChromeToolbar}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Header / controls -->
                    <Grid Grid.Row="0" Margin="12,12,12,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="AI Assistant" FontWeight="SemiBold" FontSize="15" 
                                       Foreground="{DynamicResource ChromeText}" />

                            <StackPanel Margin="0,10,0,0">
                                <TextBlock Text="Model" FontSize="11" Foreground="{DynamicResource ChromeTextSecondary}" />
                                <ComboBox Name="ModelSelector" SelectedIndex="0" FontSize="12"
                                          Background="{DynamicResource ChromeTabActive}"
                                          Foreground="{DynamicResource ChromeText}"
                                          Margin="0,4,0,0">
                                    <ComboBoxItem Content="gemini-2.5-flash" Tag="gemini-2.5-flash" />
                                    <ComboBoxItem Content="gemini-3.0-pro" Tag="gemini-3.0-pro" />
                                </ComboBox>
                            </StackPanel>
                        
                            <TextBlock Text="API key is set in Settings (âš™). Use ðŸ›  for AI tools."
                                       Margin="0,6,0,0"
                                       Foreground="{DynamicResource ChromeTextSecondary}"
                                       FontSize="10" />
                        </StackPanel>
                        
                        <!-- Clear Chat button in top-right corner -->
                        <Button Grid.Column="1" 
                                Name="ClearChatButton" 
                                Style="{StaticResource ChromeToolbarButton}"
                                Width="28" Height="28"
                                Content="ðŸ—‘" FontSize="11"
                                VerticalAlignment="Top"
                                Click="ClearChat_Click"
                                ToolTip="Clear Chat" />
                    </Grid>

                    <!-- Selection Preview (hidden when empty) -->
                    <Border Name="SelectionPreviewPanel" Grid.Row="2" 
                            Margin="12,0,12,8" Padding="8,6"
                            Background="{DynamicResource ChromeTabActive}"
                            BorderBrush="{DynamicResource ChromeBorder}"
                            BorderThickness="1" CornerRadius="6"
                            Visibility="Collapsed">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Selection:" FontSize="10" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource ChromeTextSecondary}" />
                                <TextBlock Name="SelectionPreviewText" 
                                           FontSize="11" TextTrimming="CharacterEllipsis" 
                                           MaxHeight="36" TextWrapping="Wrap"
                                           Foreground="{DynamicResource ChromeText}" />
                            </StackPanel>
                            <Button Grid.Column="1" Style="{StaticResource ChromeToolbarButton}"
                                    Content="âœ•" Width="24" Height="24" 
                                    FontSize="10" Padding="0" VerticalAlignment="Top"
                                    Click="ClearSelection_Click" ToolTip="Clear selection" />
                        </Grid>
                    </Border>

                    <!-- Conversation log with chat bubbles -->
                    <ScrollViewer Name="AiConversationScroller" Grid.Row="3"
                                  Margin="12,0,12,8"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl Name="AiConversationPanel">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Vertical" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Input area with styled border -->
                    <Grid Grid.Row="4" Margin="12,0,12,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Input box with visible border -->
                        <Border Grid.Column="0" 
                                Background="{DynamicResource ChromeTabActive}" 
                                BorderBrush="{DynamicResource ChromeBorder}"
                                BorderThickness="1"
                                CornerRadius="12" 
                                Padding="12,8" 
                                Margin="0,0,8,0">
                            <TextBox Name="AiInput"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="100"
                                     MinHeight="36"
                                     Background="Transparent"
                                     Foreground="{DynamicResource ChromeText}"
                                     CaretBrush="{DynamicResource ChromeText}"
                                     BorderThickness="0"
                                     VerticalAlignment="Center"
                                     VerticalScrollBarVisibility="Auto"
                                     PreviewKeyDown="AiQuestion_KeyDown" />
                        </Border>

                        <!-- Send button only (Clear moved to header) -->
                        <Button Grid.Column="1"
                                Name="AiSendButton" 
                                Style="{StaticResource ChromeToolbarButton}"
                                Width="44" Height="44"
                                Content="âž¤" FontSize="18"
                                Background="{DynamicResource ChromeAccent}"
                                Foreground="#202124"
                                Click="AiAsk_Click"
                                ToolTip="Send (Enter)" />
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </DockPanel>
</Window>

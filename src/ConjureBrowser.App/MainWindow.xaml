<Window x:Class="ConjureBrowser.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:cef="clr-namespace:CefSharp.Wpf;assembly=CefSharp.Wpf"
        xmlns:models="clr-namespace:ConjureBrowser.App.Models"
        mc:Ignorable="d"
        Title="Conjure Browser"
        Height="720"
        Width="1200">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />

        <!-- DataTemplate for TabHeaderModel -->
        <DataTemplate DataType="{x:Type models:TabHeaderModel}">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <!-- Favicon placeholder (globe icon) - hidden by default, shown when favicon is null -->
                <TextBlock x:Name="FaviconPlaceholder"
                           Text="ðŸŒ"
                           FontSize="12"
                           VerticalAlignment="Center"
                           Margin="0,0,4,0"
                           Visibility="Collapsed" />
                <!-- Favicon image - visible by default -->
                <Image x:Name="FaviconImage"
                       Source="{Binding Favicon}"
                       Width="16"
                       Height="16"
                       VerticalAlignment="Center"
                       Margin="0,0,4,0"
                       Visibility="Visible" />
                <!-- Title -->
                <TextBlock Text="{Binding Title}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"
                           MaxWidth="140" />
                <!-- Loading indicator -->
                <TextBlock Text="âŸ³"
                           FontSize="12"
                           VerticalAlignment="Center"
                           Margin="4,0,0,0"
                           Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                           Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}" />
            </StackPanel>
            <DataTemplate.Triggers>
                <!-- When Favicon IS null, show placeholder and hide image -->
                <DataTrigger Binding="{Binding Favicon}" Value="{x:Null}">
                    <Setter TargetName="FaviconPlaceholder" Property="Visibility" Value="Visible" />
                    <Setter TargetName="FaviconImage" Property="Visibility" Value="Collapsed" />
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </Window.Resources>

    <DockPanel LastChildFill="True">
        <!-- Top toolbar -->
        <Border DockPanel.Dock="Top" Padding="6" Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0" Name="BackButton" Width="36" Margin="0,0,6,0" Content="&lt;" Click="Back_Click" />
                <Button Grid.Column="1" Name="ForwardButton" Width="36" Margin="0,0,6,0" Content="&gt;" Click="Forward_Click" />
                <Button Grid.Column="2" Name="ReloadButton" Width="48" Margin="0,0,6,0" Content="Reload" Click="Reload_Click" />
                <Button Grid.Column="3" Width="48" Margin="0,0,6,0" Content="Home" Click="Home_Click" />

                <TextBox Grid.Column="4"
                         Name="AddressBar"
                         Margin="0,0,6,0"
                         VerticalContentAlignment="Center"
                         KeyDown="AddressBar_KeyDown"
                         PreviewMouseLeftButtonDown="AddressBar_PreviewMouseLeftButtonDown"
                         TextChanged="AddressBar_TextChanged"
                         LostKeyboardFocus="AddressBar_LostKeyboardFocus"
                         PreviewKeyDown="AddressBar_PreviewKeyDown" />

                <Button Grid.Column="5" Width="64" Margin="0,0,6,0" Content="Go" Click="Go_Click" />

                <Button Grid.Column="6"
                        Name="BookmarksMenuButton"
                        Width="64"
                        Margin="0,0,6,0"
                        Content="â˜…â–¼"
                        ToolTip="Open bookmarks"
                        Click="BookmarksMenu_Click" />

                <ToggleButton Grid.Column="7"
                              Name="BookmarkButton"
                              Width="44"
                              Content="â˜†"
                              ToolTip="Bookmark this page"
                              Click="BookmarkButton_Click" />

                <ToggleButton Grid.Column="8"
                              Name="AiPanelToggle"
                              Width="52"
                              Content="AI"
                              IsChecked="False"
                              ToolTip="Show/hide AI panel"
                              Click="AiPanelToggle_Click" />

                <!-- App Menu Button -->
                <Button Grid.Column="9"
                        Name="AppMenuButton"
                        Width="36"
                        Margin="0,0,0,0"
                        Content="â‹®"
                        FontSize="16"
                        FontWeight="Bold"
                        ToolTip="Menu"
                        Click="AppMenuButton_Click">
                    <Button.ContextMenu>
                        <ContextMenu x:Name="AppMenu" MinWidth="220" Opened="AppMenu_Opened">
                            <!-- New -->
                            <MenuItem Header="_New Tab" InputGestureText="Ctrl+T" Click="NewTabFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="+" FontWeight="Bold" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- Library -->
                            <MenuItem Header="_History" InputGestureText="Ctrl+H" Click="HistoryFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â±" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="_Downloads" InputGestureText="Ctrl+J" Click="DownloadsFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â¬‡" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- Page -->
                            <MenuItem x:Name="FindInPageMenuItem" Header="_Find in Pageâ€¦" InputGestureText="Ctrl+F" Click="FindInPageFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="ðŸ”Ž" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <!-- App -->
                            <MenuItem Header="_Settings" Click="SettingsFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="âš™" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="_About" Click="AboutFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="â„¹" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <MenuItem Header="E_xit" InputGestureText="Alt+F4" Click="ExitFromMenu_Click">
                                <MenuItem.Icon>
                                    <TextBlock Text="âœ•" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
            </Grid>
        </Border>

        <!-- Omnibox Suggestions Popup -->
        <Popup x:Name="OmniboxPopup"
               PlacementTarget="{Binding ElementName=AddressBar}"
               Placement="Bottom"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border Background="White"
                    BorderBrush="#DDD"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="2">
                <ListBox x:Name="OmniboxList"
                         MaxHeight="280"
                         Width="{Binding ActualWidth, ElementName=AddressBar}"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         MouseLeftButtonUp="OmniboxList_MouseLeftButtonUp"
                         PreviewMouseDown="OmniboxList_PreviewMouseDown"
                         BorderThickness="0"
                         Background="Transparent">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="8,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="22"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding IconText}"
                                           VerticalAlignment="Center"
                                           FontSize="14"/>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="{Binding PrimaryText}"
                                               FontWeight="SemiBold"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding SecondaryText}"
                                               Foreground="Gray"
                                               FontSize="11"
                                               TextTrimming="CharacterEllipsis"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Border>
        </Popup>

        <!-- Bookmarks Bar -->
        <Border DockPanel.Dock="Top"
                Padding="6,2"
                Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"
                BorderThickness="0,0,0,1"
                BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}">
            <Grid>
                <!-- Empty hint (visible when no bookmarks) -->
                <TextBlock Name="BookmarksBarEmptyHint"
                           Text="No bookmarks yet â€” click â˜† to add"
                           Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                           VerticalAlignment="Center"
                           Margin="4,0" />

                <!-- Bookmarks scroll viewer (visible when bookmarks exist) -->
                <ScrollViewer Name="BookmarksBarScroller"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled"
                              Visibility="Collapsed">
                    <StackPanel Name="BookmarksBarPanel"
                                Orientation="Horizontal" />
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Main content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition x:Name="AiColumn" Width="0" />
            </Grid.ColumnDefinitions>

            <!-- Browser tabs + content -->
            <Grid Grid.Column="0">
                <TabControl x:Name="Tabs"
                            SelectionChanged="Tabs_SelectionChanged"
                            BorderThickness="0"
                            Padding="0">
                    <TabControl.Resources>
                        <!-- Style to remove the border around content area -->
                        <Style TargetType="TabControl">
                            <Setter Property="BorderThickness" Value="0" />
                        </Style>
                    </TabControl.Resources>
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem">
                            <Setter Property="HeaderTemplate">
                                <Setter.Value>
                                    <DataTemplate>
                                        <DockPanel LastChildFill="True" Margin="2,0">
                                            <!-- Content presenter for TabHeaderModel or string -->
                                            <ContentPresenter Content="{Binding Header, RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                              VerticalAlignment="Center" />
                                            <Button Width="16"
                                                    Height="16"
                                                    Padding="0"
                                                    Margin="4,0,4,0"
                                                    Content="Ã—"
                                                    Tag="{Binding RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                    Click="CloseTab_Click" />
                                        </DockPanel>
                                    </DataTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </TabControl.ItemContainerStyle>
                    <!-- New Tab button as the last item in the tab strip -->
                    <TabControl.Template>
                        <ControlTemplate TargetType="TabControl">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <!-- Tab header row with tabs and + button -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal">
                                    <TabPanel IsItemsHost="True" />
                                    <Button x:Name="NewTabButton"
                                            Width="28"
                                            Height="22"
                                            Margin="2,2,0,0"
                                            Content="+"
                                            FontSize="14"
                                            VerticalAlignment="Center"
                                            Click="NewTab_Click"
                                            ToolTip="New tab (Ctrl+T)" />
                                </StackPanel>
                                <!-- Tab content area -->
                                <Border Grid.Row="1"
                                        BorderThickness="0"
                                        Background="{TemplateBinding Background}">
                                    <ContentPresenter ContentSource="SelectedContent" />
                                </Border>
                            </Grid>
                        </ControlTemplate>
                    </TabControl.Template>
                </TabControl>

                <!-- Find bar overlay -->
                <Border x:Name="FindBarContainer"
                        Visibility="Collapsed"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="10,32,10,0"
                        Padding="8,6"
                        CornerRadius="6"
                        BorderThickness="1"
                        Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"
                        BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}">
                    <StackPanel Orientation="Horizontal">
                        <TextBox x:Name="FindTextBox"
                                 Width="220"
                                 VerticalContentAlignment="Center"
                                 TextChanged="FindTextBox_TextChanged"
                                 PreviewKeyDown="FindTextBox_PreviewKeyDown" />
                        <ToggleButton x:Name="FindMatchCaseToggle"
                                      Width="28"
                                      Margin="6,0,0,0"
                                      Content="Aa"
                                      ToolTip="Match case"
                                      Checked="FindMatchCaseToggle_Changed"
                                      Unchecked="FindMatchCaseToggle_Changed" />
                        <Button x:Name="FindPrevButton"
                                Width="28"
                                Margin="6,0,0,0"
                                Content="â†‘"
                                ToolTip="Previous (Shift+Enter)"
                                Click="FindPrevButton_Click" />
                        <Button x:Name="FindNextButton"
                                Width="28"
                                Margin="2,0,0,0"
                                Content="â†“"
                                ToolTip="Next (Enter)"
                                Click="FindNextButton_Click" />
                        <TextBlock x:Name="FindCountText"
                                   Text="0/0"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0"
                                   MinWidth="40"
                                   Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}" />
                        <Button x:Name="FindCloseButton"
                                Width="24"
                                Margin="6,0,0,0"
                                Content="âœ•"
                                ToolTip="Close (Esc)"
                                Click="FindCloseButton_Click" />
                    </StackPanel>
                </Border>
            </Grid>

            <!-- AI panel -->
            <Border Grid.Column="1"
                    BorderThickness="1,0,0,0"
                    BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Header / controls -->
                    <StackPanel Grid.Row="0" Margin="10,10,10,6">
                        <TextBlock Text="AI Assistant" FontWeight="SemiBold" FontSize="14" />

                        <Grid Margin="0,8,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Model selector -->
                            <StackPanel Grid.Column="0" Margin="0,0,4,0">
                                <TextBlock Text="Model" FontSize="11" />
                                <ComboBox Name="ModelSelector" SelectedIndex="0" FontSize="11">
                                    <ComboBoxItem Content="gemini-2.5-flash" Tag="gemini-2.5-flash" />
                                    <ComboBoxItem Content="gemini-3.0-pro" Tag="gemini-3.0-pro" />
                                </ComboBox>
                            </StackPanel>
                            
                            <!-- Context Mode selector -->
                            <StackPanel Grid.Column="1" Margin="4,0,0,0">
                                <TextBlock Text="Context" FontSize="11" />
                                <ComboBox Name="ContextModeSelector" SelectedIndex="0" FontSize="11"
                                          SelectionChanged="ContextModeSelector_SelectionChanged">
                                    <ComboBoxItem Content="Auto" Tag="Auto" ToolTip="Use page context when relevant, answer generally otherwise" />
                                    <ComboBoxItem Content="Page only" Tag="Page" ToolTip="Only answer from page content" />
                                    <ComboBoxItem Content="General" Tag="General" ToolTip="Answer from general knowledge, ignore page" />
                                </ComboBox>
                            </StackPanel>
                        </Grid>
                        
                        <TextBlock Text="API key is set in Settings (âš™)"
                                   Margin="0,4,0,0"
                                   Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"
                                   FontSize="10" />
                    </StackPanel>

                    <!-- Quick Actions -->
                    <WrapPanel Grid.Row="1" Margin="10,0,10,6" Orientation="Horizontal">
                        <Button Name="SummarizePageButton" Content="ðŸ“„ Summarize" 
                                FontSize="10" Padding="6,3" Margin="0,0,4,4"
                                Click="SummarizePage_Click" ToolTip="Summarize the current page" />
                        <Button Name="KeyPointsButton" Content="ðŸ“Œ Key Points" 
                                FontSize="10" Padding="6,3" Margin="0,0,4,4"
                                Click="KeyPoints_Click" ToolTip="Extract key points from the page" />
                        <Button Name="ExplainSelectionButton" Content="ðŸ’¡ Explain Selection" 
                                FontSize="10" Padding="6,3" Margin="0,0,4,4"
                                Click="ExplainSelection_Click" ToolTip="Explain highlighted text on the page" />
                        <Button Name="CompareTabsButton" Content="âš– Compare Tabs" 
                                FontSize="10" Padding="6,3" Margin="0,0,4,4"
                                Click="CompareTabs_Click" ToolTip="Compare content from multiple tabs" />
                        <Button Name="ClearChatButton" Content="ðŸ—‘ Clear" 
                                FontSize="10" Padding="6,3" Margin="0,0,0,4"
                                Click="ClearChat_Click" ToolTip="Clear conversation" />
                    </WrapPanel>

                    <!-- Selection Preview (hidden when empty) -->
                    <Border Name="SelectionPreviewPanel" Grid.Row="2" 
                            Margin="10,0,10,6" Padding="6,4"
                            Background="{DynamicResource {x:Static SystemColors.InfoBrushKey}}"
                            BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                            BorderThickness="1" CornerRadius="4"
                            Visibility="Collapsed">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Selection:" FontSize="10" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}" />
                                <TextBlock Name="SelectionPreviewText" 
                                           FontSize="11" TextTrimming="CharacterEllipsis" 
                                           MaxHeight="36" TextWrapping="Wrap" />
                            </StackPanel>
                            <Button Grid.Column="1" Content="âœ•" Width="20" Height="20" 
                                    FontSize="10" Padding="0" VerticalAlignment="Top"
                                    Click="ClearSelection_Click" ToolTip="Clear selection" />
                        </Grid>
                    </Border>

                    <!-- Conversation log -->
                    <ScrollViewer Grid.Row="3"
                                  Margin="10,0,10,6"
                                  VerticalScrollBarVisibility="Auto">
                        <TextBlock Name="AiConversation"
                                   TextWrapping="Wrap"
                                   FontFamily="Consolas"
                                   FontSize="12"
                                   PreviewMouseDown="AiConversation_PreviewMouseDown" />
                    </ScrollViewer>

                    <!-- Input area -->
                    <Grid Grid.Row="4" Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="44" />
                        </Grid.ColumnDefinitions>

                        <TextBox Name="AiInput"
                                 Grid.Column="0"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 Height="72"
                                 VerticalScrollBarVisibility="Auto"
                                 KeyDown="AiQuestion_KeyDown"
                                 Margin="0,0,8,0" />

                        <Button Name="AiSendButton"
                                Grid.Column="1"
                                Width="36"
                                Height="36"
                                Content="âž¤"
                                Click="AiAsk_Click"
                                ToolTip="Send" />
                    </Grid>
                </Grid>
            </Border>
        </Grid>
    </DockPanel>
</Window>
